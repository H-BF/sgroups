

<details>
<summary>Environments</summary>

### Базовые переменные окружения:

Для начала зададим переменные окружния, определяющие расположение файлов и сам кластер

```bash
export BASE_DOMAIN=prorobotech.ru
export CLUSTER_NAME=example
export BASE_CLUSTER_DOMAIN=${CLUSTER_NAME}.${BASE_DOMAIN}
export MASTERCOUNT=3
export BASE_K8S_PATH="/etc/kubernetes"
export BASE_KUBELET_PATH="/var/lib/kubelet"
export CRI_ENDPOINT="/var/run/containerd/containerd.sock"
export FULL_HOST_NAME=${HOST_NAME}.${BASE_CLUSTER_DOMAIN}

```

### Переменные окружения сети:

:::warning
Просьба обратить внимание, что я не указал тут подсеть для подов, тк по моему мнению этим должен управлять сетевой плагин, а не компоненты управляющего контура.
:::

```bash
export SERVICE_CIDR="29.64.0.0/16"
export SERVICE_DNS="29.64.0.10"
export SERVICE_KUBE_API="29.64.0.1"
export LOCAL_ADDRESS=$(ip -4 addr show scope global | awk '/inet/ {print $2; exit}' | cut -d/ -f1)
```

Заранее определяем список слушающих портов, будут нам полезны для понимания кто что использует
```bash
export ETCD_SERVER_PORT="2379"
export ETCD_PEER_PORT="2380"
export ETCD_METRICS_PORT="2381"
export KUBE_APISERVER_PORT="6443"
export KUBE_CONTROLLER_MANAGER_PORT="10257"
export KUBE_SCHEDULER_PORT="10259"
export KUBELET_HEALTHZ_PORT=10248
export KUBELET_SERVER_PORT=10250
```

```bash
export BASE_DOCKER_REGISTRY="registry.k8s.io"
export PAUSED_IMAGE="pause:3.9"
```

### Версии компонентов
```bash
export KUBERNETES_VERSION="v1.30.4"
export ETCD_VERSION="3.5.3-0"
export ETCD_TOOL_VERSION="v3.5.5"
export RUNC_VERSION="v1.1.12"
export CONTAINERD_VERSION="1.7.19"
export CRICTL_VERSION=$(echo $KUBERNETES_VERSION | 
sed -r 's/^v([0-9]*).([0-9]*).([0-9]*)/v\1.\2.0/')
```

### Переменные окружения ETCD
```bash
# Список ETCD Servers
export ETCD_SERVERS=$(printf "https://master-%s.$BASE_CLUSTER_DOMAIN:$ETCD_SERVER_PORT," $(seq 1 $MASTER_COUNT) | sed 's/,$//')

# Список ETCD Peers
export ETCD_INITIAL_CLUSTER=$(seq -s, 1 $MASTER_COUNT | sed "s/\([0-9]\)/master-\1.$BASE_CLUSTER_DOMAIN=https:\/\/master-\1.$BASE_CLUSTER_DOMAIN:$ETCD_PEER_PORT/g")
```
</details>

:::note
Если вы когда-либо заглядывали в документацию от [Келси Хайтауэра](https://github.com/kelseyhightower/kubernetes-the-hard-way), то, возможно, заметили, что в конфигурационных файлах часто используются IP-адреса узлов. Этот метод, безусловно, работает, но есть более удобный способ. Чтобы упростить обслуживание и сделать дальнейшую шаблонизацию более гибкой, лучше использовать заранее известные FQDN-маски, как я уже упоминал для мастеров выше ```master-${INDEX}.${CLUSTER_NAME}.${BASE_DOMAIN}```.
:::

