import { FancyboxDiagram }  from '@site/src/components/commonBlocks/FancyboxDiagram'
import TabItem              from '@theme/TabItem'
import Tabs                 from '@theme/Tabs'
import CodeBlock            from '@theme/CodeBlock';
import { CUSTOM_VALUE }     from '@site/blog-draft/kubernetes-the-hard-way/constants/customValue'
import { CERTIFICATES }     from '@site/blog-draft/kubernetes-the-hard-way/constants/certs'

<details>
<summary>Kubernetes CA</summary>

### Переменные окружения сертификатов
<CodeBlock language="bash">
{`export BASE_K8S_PATH="${CUSTOM_VALUE.kuberneteBaseFolderPath.value}"

  mkdir -p $\{BASE_K8S_PATH\}/pki

  export KUBERNETES_CA_KEY_SIZE=${CERTIFICATES.kubernetesCA.keySize}
  export KUBERNETES_CA_KEY_PATH="${CERTIFICATES.kubernetesCA.keyPath}"
  export KUBERNETES_CA_CRT_PATH="${CERTIFICATES.kubernetesCA.crtPath}"
  export KUBERNETES_CA_CSR_CONF="${CERTIFICATES.kubernetesCA.crtConf}"

`}
</CodeBlock>


### Инструкция создания сертификатов

:::note
Для удобства добавил блок расширения, что бы в перспективе отобразить инструкции сертификатов для `cfssl`
:::

<Tabs 
    defaultValue='openssl'
    values={[
        { label: "openssl", value: "openssl" },
    ]}>
    <TabItem value='openssl'>

      ```bash
      mkdir -p ${BASE_K8S_PATH}/openssl
      ```

      #### Конфигурация `openssl` CA

      ```bash
      cat <<EOF > ${KUBERNETES_CA_CSR_CONF}
      [req]
      distinguished_name = req_distinguished_name
      x509_extensions    = v3_ca
      prompt             = no

      [req_distinguished_name]
      CN = kubernetes

      [v3_ca]
      keyUsage = critical, keyCertSign, keyEncipherment, digitalSignature
      basicConstraints = critical,CA:TRUE
      EOF
      ```

      #### Генерация приватного ключа CA сертификата

      ```bash
      openssl genrsa \
        -out "${KUBERNETES_CA_KEY_PATH}" ${KUBERNETES_CA_KEY_SIZE}
      ```

      #### Генерация публичного ключа CA сертификата

      ```bash
      openssl req \
        -x509 \
        -new \
        -nodes \
        -key "${KUBERNETES_CA_KEY_PATH}" \
        -sha256 \
        -days 3650 \
        -out "${KUBERNETES_CA_CRT_PATH}" \
        -config "${KUBERNETES_CA_CSR_CONF}"
      ```

    </TabItem>

</Tabs>

</details>

