import { FancyboxDiagram }  from '@site/src/components/commonBlocks/FancyboxDiagram'
import TabItem              from '@theme/TabItem'
import Tabs                 from '@theme/Tabs'

<details>
<summary>Kube API Certificates</summary>

```bash
mkdir -p ${BASE_K8S_PATH}/pki
mkdir -p ${BASE_K8S_PATH}/openssl/csr
mkdir -p ${BASE_K8S_PATH}/kubeconfig/
```

### Переменные окружения сертификатов
```bash
export CERTIFICATE_KEY_SIZE=2048

export KUBERNETES_KUBELET_CLIENT_KEY_PATH="${BASE_K8S_PATH}/pki/apiserver-kubelet-client.key"
export KUBERNETES_KUBELET_CLIENT_CRT_PATH="${BASE_K8S_PATH}/pki/apiserver-kubelet-client.crt"
export KUBERNETES_KUBELET_CLIENT_CRT_CONF="${BASE_K8S_PATH}/openssl/apiserver-kubelet-client.conf"
export KUBERNETES_KUBELET_CLIENT_CSR_PATH="${BASE_K8S_PATH}/openssl/csr/apiserver-kubelet-client.csr"

export KUBERNETES_FRONT_PROXY_CLIENT_KEY_PATH="${BASE_K8S_PATH}/pki/front-proxy-client.key"
export KUBERNETES_FRONT_PROXY_CLIENT_CRT_PATH="${BASE_K8S_PATH}/pki/front-proxy-client.crt"
export KUBERNETES_FRONT_PROXY_CLIENT_CRT_CONF="${BASE_K8S_PATH}/openssl/front-proxy-client.conf"
export KUBERNETES_FRONT_PROXY_CLIENT_CSR_PATH="${BASE_K8S_PATH}/openssl/csr/front-proxy-client.csr"

export KUBERNETES_ETCD_CLIENT_KEY_PATH="${BASE_K8S_PATH}/pki/apiserver-etcd-client.key"
export KUBERNETES_ETCD_CLIENT_CRT_PATH="${BASE_K8S_PATH}/pki/apiserver-etcd-client.crt"
export KUBERNETES_ETCD_CLIENT_CRT_CONF="${BASE_K8S_PATH}/openssl/apiserver-etcd-client.conf"
export KUBERNETES_ETCD_CLIENT_CSR_PATH="${BASE_K8S_PATH}/openssl/csr/apiserver-etcd-client.csr"

export KUBERNETES_SERVER_KEY_PATH="${BASE_K8S_PATH}/pki/apiserver.key"
export KUBERNETES_SERVER_CRT_PATH="${BASE_K8S_PATH}/pki/apiserver.crt"
export KUBERNETES_SERVER_CRT_CONF="${BASE_K8S_PATH}/openssl/apiserver.conf"
export KUBERNETES_SERVER_CSR_PATH="${BASE_K8S_PATH}/openssl/csr/apiserver.csr"

export KUBERNETES_SERVICE_ACCOUNT_KEY_PATH="${BASE_K8S_PATH}/pki/sa.key"
export KUBERNETES_SERVICE_ACCOUNT_CRT_PATH="${BASE_K8S_PATH}/pki/sa.pub"

export KUBERNETES_SUPER_ADMIN_CLIENT_KEY_PATH="${BASE_K8S_PATH}/kubeconfig/super-admin.key"
export KUBERNETES_SUPER_ADMIN_CLIENT_CRT_PATH="${BASE_K8S_PATH}/kubeconfig/super-admin.crt"
export KUBERNETES_SUPER_ADMIN_CLIENT_CRT_CONF="${BASE_K8S_PATH}/openssl/super-admin.conf"
export KUBERNETES_SUPER_ADMIN_CLIENT_CSR_PATH="${BASE_K8S_PATH}/openssl/csr/super-admin.csr"

export KUBERNETES_ADMIN_CLIENT_KEY_PATH="${BASE_K8S_PATH}/kubeconfig/admin.key"
export KUBERNETES_ADMIN_CLIENT_CRT_PATH="${BASE_K8S_PATH}/kubeconfig/admin.crt"
export KUBERNETES_ADMIN_CLIENT_CRT_CONF="${BASE_K8S_PATH}/openssl/admin.conf"
export KUBERNETES_ADMIN_CLIENT_CSR_PATH="${BASE_K8S_PATH}/openssl/csr/admin.csr"
```

### Инструкция создания сертификатов

:::note
Для удобства добавил блок расширения, что бы в перспективе отобразить инструкции сертификатов для `cfssl`
:::

<Tabs 
    defaultValue='openssl'
    values={[
        { label: "openssl", value: "openssl" },
    ]}>
    <TabItem value='openssl'>

      #### Конфигурация `openssl` kubernetes-etcd-client

      ```bash
      cat <<EOF > ${KUBERNETES_ETCD_CLIENT_CRT_CONF}
      [ req ]
      default_bits        = ${CERTIFICATE_KEY_SIZE}
      prompt              = no
      default_md          = sha256
      distinguished_name  = dn

      [ dn ]
      CN = kube-apiserver-etcd-client

      [ v3_ext ]
      authorityKeyIdentifier=keyid,issuer:always
      basicConstraints=CA:FALSE
      keyUsage=keyEncipherment,dataEncipherment
      extendedKeyUsage=clientAuth
      EOF
      ```

      #### Конфигурация `openssl` kubernetes-kubelet-client

      ```bash
      cat <<EOF > ${KUBERNETES_KUBELET_CLIENT_CRT_CONF}
      [ req ]
      default_bits        = ${CERTIFICATE_KEY_SIZE}
      prompt              = no
      default_md          = sha256
      distinguished_name  = dn

      [ dn ]
      CN = kube-apiserver-kubelet-client
      O  = kubeadm:cluster-admins

      [ v3_ext ]
      authorityKeyIdentifier=keyid,issuer:always
      basicConstraints=CA:FALSE
      keyUsage=keyEncipherment,dataEncipherment
      extendedKeyUsage=clientAuth
      EOF
      ```

      #### Конфигурация `openssl` kubernetes-super-admin-client

      ```bash
      cat <<EOF > ${KUBERNETES_SUPER_ADMIN_CLIENT_CRT_CONF}
      [ req ]
      default_bits        = ${CERTIFICATE_KEY_SIZE}
      prompt              = no
      default_md          = sha256
      distinguished_name  = dn

      [ dn ]
      CN = kubernetes-super-admin
      O  = system:masters

      [ v3_ext ]
      authorityKeyIdentifier=keyid,issuer:always
      basicConstraints=CA:FALSE
      keyUsage=keyEncipherment,dataEncipherment
      extendedKeyUsage=clientAuth
      EOF
      ```

      #### Конфигурация `openssl` kubernetes-admin-client

      ```bash
      cat <<EOF > ${KUBERNETES_ADMIN_CLIENT_CRT_CONF}
      [ req ]
      default_bits        = ${CERTIFICATE_KEY_SIZE}
      prompt              = no
      default_md          = sha256
      distinguished_name  = dn

      [ dn ]
      CN = kubernetes-admin
      O  = kubeadm:cluster-admins

      [ v3_ext ]
      authorityKeyIdentifier=keyid,issuer:always
      basicConstraints=CA:FALSE
      keyUsage=keyEncipherment,dataEncipherment
      extendedKeyUsage=clientAuth
      EOF
      ```

      #### Конфигурация `openssl` kubernetes-front-proxy-client

      ```bash
      cat <<EOF > ${KUBERNETES_FRONT_PROXY_CLIENT_CRT_CONF}
      [ req ]
      default_bits        = ${CERTIFICATE_KEY_SIZE}
      prompt              = no
      default_md          = sha256
      distinguished_name  = dn

      [ dn ]
      CN = front-proxy-client

      [ v3_ext ]
      authorityKeyIdentifier=keyid,issuer:always
      basicConstraints=CA:FALSE
      keyUsage=keyEncipherment,dataEncipherment
      extendedKeyUsage=clientAuth
      EOF
      ```

      #### Конфигурация `openssl` kubernetes-server

      ```bash
      cat <<EOF > ${KUBERNETES_SERVER_CRT_CONF}
      [ req ]
      default_bits        = ${CERTIFICATE_KEY_SIZE}
      prompt              = no
      default_md          = sha256
      distinguished_name  = dn
      req_extensions      = req_ext

      [ req_ext ]
      subjectAltName = @alt_names

      [ alt_names ]
      DNS.1 = kubernetes
      DNS.2 = kubernetes.default
      DNS.3 = kubernetes.default.svc
      DNS.4 = kubernetes.default.svc.${BASE_CLUSTER_DOMAIN}
      DNS.5 = ${FULL_HOST_NAME}
      IP.1  = ${LOCAL_ADDRESS}
      IP.2  = 127.0.0.1

      [ dn ]
      CN = kube-apiserver

      [ v3_ext ]
      authorityKeyIdentifier=keyid,issuer:always
      basicConstraints=CA:FALSE
      keyUsage=keyEncipherment,dataEncipherment
      extendedKeyUsage=serverAuth
      subjectAltName=@alt_names
      EOF
      ```

      #### Генерация приватных ключей сертификатов

      ```bash
      openssl genrsa \
        -out "${KUBERNETES_KUBELET_CLIENT_KEY_PATH}" ${CERTIFICATE_KEY_SIZE}
      openssl genrsa \
        -out "${KUBERNETES_FRONT_PROXY_CLIENT_KEY_PATH}" ${CERTIFICATE_KEY_SIZE}
      openssl genrsa \
        -out "${KUBERNETES_ETCD_CLIENT_KEY_PATH}" ${CERTIFICATE_KEY_SIZE}
      openssl genrsa \
        -out "${KUBERNETES_SERVER_KEY_PATH}" ${CERTIFICATE_KEY_SIZE}
      openssl genrsa \
        -out "${KUBERNETES_SUPER_ADMIN_CLIENT_KEY_PATH}" ${CERTIFICATE_KEY_SIZE}
      openssl genrsa \
        -out "${KUBERNETES_ADMIN_CLIENT_KEY_PATH}" ${CERTIFICATE_KEY_SIZE}
      ```

      #### Генерация CSR будущих сертификатов

      ```bash
      openssl req \
        -new \
        -key    "${KUBERNETES_KUBELET_CLIENT_KEY_PATH}" \
        -out    "${KUBERNETES_KUBELET_CLIENT_CSR_PATH}" \
        -config "${KUBERNETES_KUBELET_CLIENT_CRT_CONF}"

      openssl req \
        -new \
        -key    "${KUBERNETES_FRONT_PROXY_CLIENT_KEY_PATH}" \
        -out    "${KUBERNETES_FRONT_PROXY_CLIENT_CSR_PATH}" \
        -config "${KUBERNETES_FRONT_PROXY_CLIENT_CRT_CONF}"

      openssl req \
        -new \
        -key    "${KUBERNETES_ETCD_CLIENT_KEY_PATH}" \
        -out    "${KUBERNETES_ETCD_CLIENT_CSR_PATH}" \
        -config "${KUBERNETES_ETCD_CLIENT_CRT_CONF}"

      openssl req \
        -new \
        -key    "${KUBERNETES_SERVER_KEY_PATH}" \
        -out    "${KUBERNETES_SERVER_CSR_PATH}" \
        -config "${KUBERNETES_SERVER_CRT_CONF}"

      openssl req \
        -new \
        -key    "${KUBERNETES_SUPER_ADMIN_CLIENT_KEY_PATH}" \
        -out    "${KUBERNETES_SUPER_ADMIN_CLIENT_CSR_PATH}" \
        -config "${KUBERNETES_SUPER_ADMIN_CLIENT_CRT_CONF}"

      openssl req \
        -new \
        -key    "${KUBERNETES_ADMIN_CLIENT_KEY_PATH}" \
        -out    "${KUBERNETES_ADMIN_CLIENT_CSR_PATH}" \
        -config "${KUBERNETES_ADMIN_CLIENT_CRT_CONF}"
      ```

      #### Подпись CSR ключом удостоверяющего центра (CA)

      ```bash
      openssl x509 \
        -req \
        -days 365 \
        -sha256 \
        -CA "${KUBERNETES_CA_CRT_PATH}" \
        -CAkey "${KUBERNETES_CA_KEY_PATH}" \
        -CAcreateserial \
        -in "${KUBERNETES_KUBELET_CLIENT_CSR_PATH}" \
        -out "${KUBERNETES_KUBELET_CLIENT_CRT_PATH}" \
        -extensions v3_ext \
        -extfile "${KUBERNETES_KUBELET_CLIENT_CRT_CONF}"

      openssl x509 \
        -req \
        -days 365 \
        -sha256 \
        -CA "${FRONT_PROXY_CA_CRT_PATH}" \
        -CAkey "${FRONT_PROXY_CA_KEY_PATH}" \
        -CAcreateserial \
        -in "${KUBERNETES_FRONT_PROXY_CLIENT_CSR_PATH}" \
        -out "${KUBERNETES_FRONT_PROXY_CLIENT_CRT_PATH}" \
        -extensions v3_ext \
        -extfile "${KUBERNETES_FRONT_PROXY_CLIENT_CRT_CONF}"

      openssl x509 \
        -req \
        -days 365 \
        -sha256 \
        -CA "${ETCD_CA_CRT_PATH}" \
        -CAkey "${ETCD_CA_KEY_PATH}" \
        -CAcreateserial \
        -in "${KUBERNETES_ETCD_CLIENT_CSR_PATH}" \
        -out "${KUBERNETES_ETCD_CLIENT_CRT_PATH}" \
        -extensions v3_ext \
        -extfile "${KUBERNETES_ETCD_CLIENT_CRT_CONF}"

      openssl x509 \
        -req \
        -days 365 \
        -sha256 \
        -CA "${KUBERNETES_CA_CRT_PATH}" \
        -CAkey "${KUBERNETES_CA_KEY_PATH}" \
        -CAcreateserial \
        -in "${KUBERNETES_SERVER_CSR_PATH}" \
        -out "${KUBERNETES_SERVER_CRT_PATH}" \
        -extensions v3_ext \
        -extfile "${KUBERNETES_SERVER_CRT_CONF}"

      openssl x509 \
        -req \
        -days 365 \
        -sha256 \
        -CA "${KUBERNETES_CA_CRT_PATH}" \
        -CAkey "${KUBERNETES_CA_KEY_PATH}" \
        -CAcreateserial \
        -in "${KUBERNETES_SUPER_ADMIN_CLIENT_CSR_PATH}" \
        -out "${KUBERNETES_SUPER_ADMIN_CLIENT_CRT_PATH}" \
        -extensions v3_ext \
        -extfile "${KUBERNETES_SUPER_ADMIN_CLIENT_CRT_CONF}"

      openssl x509 \
        -req \
        -days 365 \
        -sha256 \
        -CA "${KUBERNETES_CA_CRT_PATH}" \
        -CAkey "${KUBERNETES_CA_KEY_PATH}" \
        -CAcreateserial \
        -in "${KUBERNETES_ADMIN_CLIENT_CSR_PATH}" \
        -out "${KUBERNETES_ADMIN_CLIENT_CRT_PATH}" \
        -extensions v3_ext \
        -extfile "${KUBERNETES_ADMIN_CLIENT_CRT_CONF}"

      ```

      #### Генерация приватных ключей `service-accounts`

      ```bash
      openssl genpkey \
        -algorithm RSA \
        -out "${KUBERNETES_SERVICE_ACCOUNT_KEY_PATH}" \
        -pkeyopt rsa_keygen_bits:2048

      openssl rsa \
        -pubout \
        -in "${KUBERNETES_SERVICE_ACCOUNT_KEY_PATH}" \
        -out "${KUBERNETES_SERVICE_ACCOUNT_CRT_PATH}"
      ```
    </TabItem>

</Tabs>

### Инструкция создания Kubeconfigs

#### Настройка Kubeconfig для `admin`

```bash
kubectl config set-cluster kubernetes \
  --certificate-authority=${KUBERNETES_CA_CRT_PATH} \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=${BASE_K8S_PATH}/admin.conf

kubectl config set-credentials system:node:${HOST_NAME} \
  --client-certificate=${KUBERNETES_ADMIN_CLIENT_CRT_PATH} \
  --client-key=${KUBERNETES_ADMIN_CLIENT_KEY_PATH} \
  --embed-certs=true \
  --kubeconfig=${BASE_K8S_PATH}/admin.conf

kubectl config set-context default \
  --cluster=kubernetes \
  --user=system:node:${HOST_NAME} \
  --kubeconfig=${BASE_K8S_PATH}/admin.conf

kubectl config use-context default --kubeconfig=${BASE_K8S_PATH}/admin.conf
```

#### Настройка Kubeconfig для `super-admin`

```bash
kubectl config set-cluster kubernetes \
  --certificate-authority=${KUBERNETES_CA_CRT_PATH} \
  --embed-certs=true \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=${BASE_K8S_PATH}/super-admin.conf

kubectl config set-credentials system:node:${HOST_NAME} \
  --client-certificate=${KUBERNETES_SUPER_ADMIN_CLIENT_CRT_PATH} \
  --client-key=${KUBERNETES_SUPER_ADMIN_CLIENT_KEY_PATH} \
  --embed-certs=true \
  --kubeconfig=${BASE_K8S_PATH}/super-admin.conf

kubectl config set-context default \
  --cluster=kubernetes \
  --user=system:node:${HOST_NAME} \
  --kubeconfig=${BASE_K8S_PATH}/super-admin.conf

kubectl config use-context default --kubeconfig=${BASE_K8S_PATH}/super-admin.conf
```




</details>


