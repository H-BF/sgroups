
<details>
<summary>KubeAPI Certificates</summary>


```bash
mkdir -p ${BASE_K8S_PATH}/pki/kubeAPI
```

```bash
cat <<EOF > ${BASE_K8S_PATH}/cfssl/kube-api-kubelet-client.json
{
  "CN": "kube-apiserver-kubelet-client",
  "key": {
    "algo": "rsa",
    "size": 4096
  },
  "names": [
    {
      "O": "system:masters",
      "OU": "Kubernetes"
    }
  ]
}
EOF
```

```bash
cat <<EOF > ${BASE_K8S_PATH}/cfssl/kube-api-kubernetes-admin-client.json
{
  "CN": "kubernetes-admin",
  "key": {
    "algo": "rsa",
    "size": 4096
  },
  "names": [
    {
      "O": "system:masters",
      "OU": "Kubernetes"
    }
  ]
}
EOF
```

```bash
cat <<EOF > ${BASE_K8S_PATH}/cfssl/kube-api-front-proxy-client.json
{
  "CN": "front-proxy-client",
  "key": {
    "algo": "rsa",
    "size": 4096
  }
}
EOF
```


```bash
cat <<EOF > ${BASE_K8S_PATH}/cfssl/kube-api-etcd-client.json
{
  "CN": "kube-apiserver-etcd-client",
  "key": {
    "algo": "rsa",
    "size": 4096
  },
  "names": [
    {
      "O": "system:masters",
      "OU": "Kubernetes"
    }
  ]
}
EOF
```

```bash
cat <<EOF > ${BASE_K8S_PATH}/cfssl/kube-api-server.json
{
  "CN": "kube-apiserver",
  "key": {
    "algo": "rsa",
    "size": 4096
  },
  "hosts": [
    "${HOST_NAME}",
    "${SERVICE_KUBE_API}",
    "${LOCAL_ADDRESS}",
    "${KUBE_VIP_ADDRESS}",
    "kubernetes",
    "kubernetes.default",
    "kubernetes.default.svc",
    "kubernetes.default.svc.${BASE_CLUSTER_DOMAIN}",
    "127.0.0.1",
    "0:0:0:0:0:0:0:1"
  ]
}
EOF
```

```bash
openssl genrsa -out ${BASE_K8S_PATH}/pki/kubeAPI/sa.key 4096
openssl rsa -in ${BASE_K8S_PATH}/pki/kubeAPI/sa.key -pubout -out ${BASE_K8S_PATH}/pki/kubeAPI/sa.pub

cfssl gencert -ca=${BASE_K8S_PATH}/pki/ca/kubernetes-ca.pem   -ca-key=${BASE_K8S_PATH}/pki/ca/kubernetes-ca-key.pem   -config=${BASE_K8S_PATH}/cfssl/kubernetes-ca-config.json  -profile=client ${BASE_K8S_PATH}/cfssl/kube-api-kubernetes-admin-client.json  | cfssljson -bare ${BASE_K8S_PATH}/pki/kubeAPI/client-kubernetes-admin

cfssl gencert -ca=${BASE_K8S_PATH}/pki/ca/kubernetes-ca.pem   -ca-key=${BASE_K8S_PATH}/pki/ca/kubernetes-ca-key.pem   -config=${BASE_K8S_PATH}/cfssl/kubernetes-ca-config.json  -profile=client ${BASE_K8S_PATH}/cfssl/kube-api-kubelet-client.json           | cfssljson -bare ${BASE_K8S_PATH}/pki/kubeAPI/client-kubelet
cfssl gencert -ca=${BASE_K8S_PATH}/pki/ca/front-proxy-ca.pem  -ca-key=${BASE_K8S_PATH}/pki/ca/front-proxy-ca-key.pem  -config=${BASE_K8S_PATH}/cfssl/front-proxy-ca-config.json -profile=client ${BASE_K8S_PATH}/cfssl/kube-api-front-proxy-client.json       | cfssljson -bare ${BASE_K8S_PATH}/pki/kubeAPI/client-front-proxy
cfssl gencert -ca=${BASE_K8S_PATH}/pki/ca/etcd-ca.pem         -ca-key=${BASE_K8S_PATH}/pki/ca/etcd-ca-key.pem         -config=${BASE_K8S_PATH}/cfssl/etcd-ca-config.json        -profile=client ${BASE_K8S_PATH}/cfssl/kube-api-etcd-client.json              | cfssljson -bare ${BASE_K8S_PATH}/pki/kubeAPI/client-etcd
cfssl gencert -ca=${BASE_K8S_PATH}/pki/ca/kubernetes-ca.pem   -ca-key=${BASE_K8S_PATH}/pki/ca/kubernetes-ca-key.pem   -config=${BASE_K8S_PATH}/cfssl/kubernetes-ca-config.json  -profile=server ${BASE_K8S_PATH}/cfssl/kube-api-server.json                   | cfssljson -bare ${BASE_K8S_PATH}/pki/kubeAPI/server

```

```bash
kubectl config set-cluster kubernetes \
  --certificate-authority=${BASE_K8S_PATH}/pki/ca/kubernetes-ca.pem \
  --embed-certs=false \
  --server=https://127.0.0.1:6443 \
  --kubeconfig=${BASE_K8S_PATH}/admin.conf

kubectl config set-credentials system:node:${HOST_NAME} \
  --client-certificate=${BASE_K8S_PATH}/pki/kubeAPI/client-kubernetes-admin.pem \
  --client-key=${BASE_K8S_PATH}/pki/kubeAPI/client-kubernetes-admin-key.pem \
  --embed-certs=false \
  --kubeconfig=${BASE_K8S_PATH}/admin.conf

kubectl config set-context default \
  --cluster=kubernetes \
  --user=system:node:${HOST_NAME} \
  --kubeconfig=${BASE_K8S_PATH}/admin.conf

kubectl config use-context default --kubeconfig=${BASE_K8S_PATH}/admin.conf
```

</details>
